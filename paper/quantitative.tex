%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[sigplan,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[sigplan,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[sigplan]{acmart}\settopmatter{}


%% Conference information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmConference[PL'18]{ACM SIGPLAN Conference on Programming Languages}{January 01--03, 2018}{New York, NY, USA}
\acmYear{2018}
\acmISBN{} % \acmISBN{978-x-xxxx-xxxx-x/YY/MM}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%\citestyle{acmauthoryear}  %% For author/year citations
%\citestyle{acmnumeric}     %% For numeric citations
%\setcitestyle{nosort}      %% With 'acmnumeric', to disable automatic
                            %% sorting of references within a single citation;
                            %% e.g., \cite{Smith99,Carpenter05,Baker12}
                            %% rendered as [14,5,2] rather than [2,5,14].
%\setcitesyle{nocompress}   %% With 'acmnumeric', to disable automatic
                            %% compression of sequential references within a
                            %% single citation;
                            %% e.g., \cite{Baker12,Baker14,Baker16}
                            %% rendered as [2,3,4] rather than [2-4].


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from traditional SIGPLAN
%% proceedings format to PACMPL format must update the
%% '\documentclass' and topmatter commands above; see
%% 'acmart-pacmpl-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption

\usepackage{stmaryrd}
\usepackage{mathpartir}
\usepackage{amssymb}
\usepackage{cmll}


\newcommand{\ann}[2]{#1 : #2}
\newcommand{\emb}[1]{\underline{#1}}

\newcommand{\fun}[2]{#1 \multimap #2}
\newcommand{\lam}[2]{\lambda #1. #2}
\newcommand{\app}[2]{#1\ #2}

\newcommand{\excl}[2]{\oc_{#1} #2}
\newcommand{\bang}[1]{\operatorname{bang}\ #1}
\newcommand{\bm}[3]{\operatorname{bm}_{#1}(#2, #3)}

\newcommand{\tensorOne}[0]{1}
\newcommand{\unit}[0]{{*}_\otimes}
\newcommand{\del}[3]{\operatorname{del}_{#1}(#2, #3)}

\newcommand{\tensor}[2]{#1 \otimes #2}
\newcommand{\ten}[2]{(#1, #2)_{\otimes}}
\newcommand{\prm}[3]{\operatorname{pm}_{#1}(#2, #3)}

\newcommand{\withTOne}[0]{\top}
\newcommand{\eat}[0]{{*}_{\with}}

\newcommand{\withT}[2]{#1 \with #2}
\newcommand{\wth}[2]{(#1, #2)_{\with}}
\newcommand{\proj}[2]{\operatorname{proj}_{#1}(#2)}

\newcommand{\sumTZero}[0]{0}
\newcommand{\exf}[2]{\operatorname{ex-falso}_{#1}(#2)}

\newcommand{\sumT}[2]{#1 \oplus #2}
\newcommand{\inj}[2]{\operatorname{inj}_{#1}(#2)}
\newcommand{\cse}[4]{\operatorname{case}_{#1}(#2, #3, #4)}


\newcommand{\bind}[2]{(#1)#2}

\begin{document}

%% Title information
\title%[Short Title]
       {Refined Semantics for Coeffects} %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
\titlenote{Working title}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{Robert Atkey}
%\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
%\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  % \position{Position1}
  \department{Computer and Information Sciences}              %% \department is recommended
  \institution{University of Strathclyde}            %% \institution is required
  % \streetaddress{Street1 Address1}
  % \city{City1}
  % \state{State1}
  % \postcode{Post-Code1}
%  \country{UK}                    %% \country is recommended
}
\email{robert.atkey@strath.ac.uk}          %% \email is recommended

%% Author with two affiliations and emails.
\author{James Wood}
% \authornote{with }          %% \authornote is optional;
                                        %% can be repeated if necessary
%\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  % \position{Position2a}
  \department{Computer and Information Sciences}              %% \department is recommended
  \institution{University of Strathclyde}            %% \institution is required
  % \streetaddress{Street2a Address2a}
  % \city{City2a}
  % \state{State2a}
  % \postcode{Post-Code2a}
%  \country{UK}                   %% \country is recommended
}
\email{james.wood.100@strath.ac.uk}         %% \email is recommended


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
  Key message: refined typing permits refined
  semantics. Domain-specific properties for domain-specific
  programming languages.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle


\section{Introduction}

The Story:
\begin{enumerate}
\item We want to have a way of describing DSLs that are purely
  functional programs at heart, but have some special intensional
  properties stemming from restrictions on how they use the resources
  they are handed. Examples:
  \begin{enumerate}
  \item Linear type systems that ensure preservation of data
  \item Monotonicity
  \item Information flow
  \item Metric spaces and input sensitivity
  \end{enumerate}
\item We track how resources are used by using a ``quantitative
  coeffect'' system.
\item We build our system in stages, enabling reflective proof
  procedures that lift us from well-scoped terms to well-typed terms
  to well-resourced terms.
\item Well typed terms are equipped with a standard semantics: types
  are interpreted as (Agda) Sets, and terms are interpreted as Agda
  functions.
\item The resource typing permits more refined semantics, and this is
  where the fun starts. We give a general semantics that can be
  instantiated to any of our examples. These semantics capture (a) the
  constrained resource behaviour of programs (via Kripke indexing);
  and (b) the constrained observational behaviour of programs (via
  relations); both of these are consequences of the types.
\item Give some examples of the theorems that result from our
  semantics.
\item (everything has been formalised in Agda)
\end{enumerate}

\section{Background}

\begin{enumerate}
\item Petricek and Orchard
\item Brunel et al
\item Ghica and Smith
\item Benton/Kennedy/Hofmann relational refinements
\item Atkey/Johann/Kennedy algebraic indexed types
\item Gaboardi et al
\end{enumerate}

\section{Well-scoped and Well-typed Programs}

\subsection{Well-scoped Syntax}

FIXME: is it possible to remove the Ty type from Quantitative.Syntax?
Ideally, the Syntax should just be parameterised by the form of type
annotations. The Syntax shouldn't depend on the resource semiring.

\begin{displaymath}
  \begin{array}{rrll}
    \pi,\rho & \in & R & \textrm{resource annotations} \\
    i & \in & \{0,1\} & \textrm{sides}
    \\\\
    S,T &  ::= & \fun{S}{T}                    & \textrm{function} \\
        & \mid & \excl{\rho}{S}                & \textrm{bang} \\
        & \mid & \tensorOne \mid \tensor{S}{T} & \textrm{tensor product} \\
        & \mid & \withTOne \mid \withT{S}{T}   & \textrm{with} \\
        & \mid & \sumTZero \mid \sumT{S}{T}    & \textrm{sum}
    \\\\
    s &  ::= & \lam{x}{s} & \textrm{lambda abstraction} \\
      & \mid & \bang{s} & \textrm{bang introduction} \\
      & \mid & \unit \mid \ten{s_0}{s_1} & \textrm{tensor product} \\
      &      &                           & \textrm{introduction} \\
      & \mid & \eat \mid \wth{s_0}{s_1} & \textrm{with introduction} \\
      & \mid & \inj{i}{s} & \textrm{sum introduction}
    \\
    e &  ::= & x & \textrm{variable} \\
      & \mid & \bm{T}{e}{\bind{x}{s}}  & \textrm{pattern matching} \\
      &      &                         & \textrm{for bang} \\
      & \mid & \del{T}{e}{s} & \textrm{deletion of tensor unit} \\
      & \mid & \prm{T}{e}{\bind{x,y}{s}} & \textrm{pattern matching} \\
      &      &                           & \textrm{for tensor products} \\
      & \mid & \proj{i}{e} & \textrm{projection for with} \\
      & \mid & \exf{T}{e} & \textrm{absurd elimination} \\
      & \mid & \cse{T}{e}{\bind{x}{s_0}}{\bind{y}{s_1}}
                       & \textrm{case analysis for sums}
  \end{array}
\end{displaymath}

\subsection{Well-typed}

Types enable us to give a total functional semantics to terms. FIXME:
Is it possible to make Quantitative.Types have its own notion of types
that we can show is related to the resourced types? (the need for
special constructs for introducing and eliminating bangs is a wrinkle
here).

\begin{mathpar}
  % Variables
  \inferrule{(x : S) \in \Gamma}
            {\Gamma \vdash x \in S}

  % Embedding
  \inferrule{\Gamma \vdash S \ni s}
            {\Gamma \vdash (\ann{s}{S}) \in S}
            
  \inferrule{\Gamma \vdash e \in S}
            {\Gamma \vdash S \ni \emb{e}}

  % Functions
  \inferrule{\Gamma, x : S \vdash T \ni s[x]}
            {\Gamma \vdash \fun{S}{T} \ni \lam{x}{s[x]}}

  \inferrule{\Gamma \vdash e \in \fun{S}{T} \\ \Gamma \vdash S \ni s}
            {\Gamma \vdash \app{e}{s} \in T}

  % Bang
  \inferrule{\Gamma \vdash S \ni s}
            {\Gamma \vdash \excl{\rho}{S} \ni \bang{s}}

  \inferrule{\Gamma \vdash e \in \excl{\rho}{S} \\ \Gamma, x^S \vdash T \ni s[x]}
            {\Gamma \vdash \bm{T}{e}{\bind{x}{s[x]}} \in T}

  % Tensor unit
  \inferrule{}
            {\Gamma \vdash \tensorOne \ni \unit}

  \inferrule{\Gamma \vdash e \in \tensorOne \\ \Gamma \vdash T \ni s}
            {\Gamma \vdash \del{T}{e}{s} \in T}

  % Tensor
  \inferrule{\Gamma \vdash S_0 \ni s_0 \\ \Gamma \vdash S_1 \ni s_1}
            {\Gamma \vdash \tensor{S_0}{S_1} \ni \ten{s_0}{s_1}}

  \inferrule{\Gamma \vdash e \in \tensor{S_0}{S_1} \\ \Gamma, x : S_0, y : S_1 \vdash T \ni s[x,y]}
            {\Gamma \vdash \prm{T}{e}{\bind{x,y}{s[x,y]}} \in T}

  % With unit
  \inferrule{ }
            {\Gamma \vdash \withTOne \ni \eat}

  %(no \withTOne elim)

  % With
  \inferrule{\Gamma \vdash S_0 \ni s_0 \\ \Gamma \vdash S_1 \ni s_1}
            {\Gamma \vdash \withT{S_0}{S_1} \ni \wth{s_0}{s_1}}

  \inferrule{\Gamma \vdash e \in \withT{S_0}{S_1}}
            {\Gamma \vdash \proj{i}{e} \in S_i}

  % Sum unit
  %(no \sumTZero intro)

  \inferrule{\Gamma \vdash e \in \sumTZero}
            {\Gamma \vdash \exf{T}{e} \in T}

  % Sum
  \inferrule{\Gamma \vdash S_i \ni s}
            {\Gamma \vdash \sumT{S_0}{S_1} \ni \inj{i}{s}}

  \inferrule{\Gamma \vdash e \in \sumT{S_0}{S_1}
              \\ \Gamma, x : S_0 \vdash T \ni s_0[x]
              \\ \Gamma, y : S_1 \vdash T \ni s_1[y]}
            {\Gamma \vdash \cse{T}{e}{\bind{x}{s_0[x]}}{\bind{y}{s_1[y]}} \in T}
\end{mathpar}

\section{Resourced Terms}

Present the refinement of typed terms via resources.

\subsection{Partially-ordered Semirings}

\subsection{Resourced Terms}

FIXME: how to present these with respect to typing derivations, especially for
bang. Maybe annotate bang and bm with $\rho$.

\begin{mathpar}
 % Variables
  \inferrule{\Delta, \Delta' \leq 0 \\ \rho \leq 1}
            {\Delta, x^\rho, \Delta' \vdash x}

  % Embedding
  \inferrule{\Delta \vdash s}
            {\Delta \vdash (s : S)}
            
  \inferrule{\Delta \vdash e}
            {\Delta \vdash \emb{e}}

  % Functions
  \inferrule{\Delta, x^1 \vdash s[x]}
            {\Delta \vdash \lam{x}{s[x]}}
            
  \inferrule{\Delta \vdash e \\ \Delta \vdash s}
            {\Delta \vdash \app{e}{s}}

  % Bang
  \inferrule{\Delta_s \vdash s \\ \Delta \leq \rho \cdot \Delta_s}
            {\Delta \vdash \bang{s}}

  \inferrule{\Delta_e \vdash e \\ \Delta_s, x^\rho \vdash s[x]
              \\ \Delta \leq \Delta_e + \Delta_s}
            {\Delta \vdash \bm{T}{e}{\bind{x}{s[x]}}}

  % Tensor unit
  \inferrule{\Delta \leq 0}
            {\Delta \vdash \unit}

  \inferrule{\Delta_e \vdash e \\ \Delta_s \vdash s
              \\ \Delta \leq \Delta_e + \Delta_s}
            {\Delta \vdash \del{T}{e}{s}}

  % Tensor
  \inferrule{\Delta_0 \vdash s_0 \\ \Delta_1 \vdash s_1
              \\ \Delta \leq \Delta_0 + \Delta_1}
            {\Delta \vdash \ten{s_0}{s_1}}

  \inferrule{\Delta_e \vdash e \\ \Delta_s, x^1, y^1 \vdash s[x,y]
              \\ \Delta \leq \Delta_e + \Delta s}
            {\Delta \vdash \prm{T}{e}{\bind{x,y}{s[x,y]}}}

  % With unit
  \inferrule{ }
            {\Delta \vdash \eat}

  %(no \withTOne elim)

  % With
  \inferrule{\Delta \vdash s_0 \\ \Delta \vdash s_1}
            {\Delta \vdash \wth{s_0}{s_1}}

  \inferrule{\Delta \vdash e}
            {\Delta \vdash \proj{i}{e}}

  % Sum unit
  %(no \sumTZero intro)

  \inferrule{\Delta_e \vdash e \\ \Delta \leq \Delta_e + \Delta_s}
            {\Delta \vdash \exf{T}{e}}

  % Sum
  \inferrule{\Delta \vdash s}
            {\Delta \vdash \inj{i}{s}}

  \inferrule{\Delta_e \vdash e
              \\ \Delta_s, x^1 \vdash s_0[x]
              \\ \Delta_s, y^1 \vdash s_1[y]
              \\ \Delta \leq \Delta_e + \Delta_s}
            {\Delta \vdash \cse{T}{e}{\bind{x}{s_0[x]}}{\bind{y}{s_1[y]}}}
\end{mathpar}

\section{Relational Semantics}

Plan: for terms that are well-typed and well-resourced, 

\section{Example Instantiations}

\subsection{Permutations}

\subsection{Information Flow}

Idea: we make a semiring from the bilattice of confidentiality and
integrity.

\subsection{Monotonicity}

\subsection{Metric Spaces and Sensitivity}

\section{Conclusions}

TODO:
\begin{enumerate}
\item Mixing with effects
\item Dependent types
\item Non-termination (could use a step indexed/topos of trees model)
\item Coeffect polymorphism (could we just do this? Needs a more
  complex model of types)
\item The layers of well-formed-ness be presented via a system of
  ornamentation?
\end{enumerate}

%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  % This material is based upon work supported by the
  % \grantsponsor{GS100000001}{National Science
  %   Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  % No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  % No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  % conclusions or recommendations expressed in this material are those
  % of the author and do not necessarily reflect the views of the
  % National Science Foundation.
  James Wood is supported by a EPSRC award (FIXME).
\end{acks}


%% Bibliography
%\bibliography{bibfile}


%% Appendix
% \appendix
% \section{Appendix}

% Text of appendix \ldots

\end{document}
